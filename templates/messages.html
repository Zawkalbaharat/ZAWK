<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<title>ğŸ“¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ / Messages</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
<style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8f9fa;
        }
        .non-employee {
            background-color: #fff3cd !important;
        }
        .unread {
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="container mt-4">
<div class="mb-3">
<a class="btn btn-success" href="{{ return_url }}">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… / Back to Dashboard</a>
</div>
<h2 class="text-center text-success mb-4">ğŸ“¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ / Messages</h2>
<ul class="nav nav-tabs mb-3" id="messageTabs" role="tablist">
<li class="nav-item" role="presentation">
<button class="nav-link active" data-bs-target="#inbox" data-bs-toggle="tab" id="inbox-tab" role="tab" type="button">ğŸ“¥ Ø§Ù„ÙˆØ§Ø±Ø¯ / Inbox</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" data-bs-target="#sent" data-bs-toggle="tab" id="sent-tab" role="tab" type="button">ğŸ“¤ Ø§Ù„ØµØ§Ø¯Ø± / Sent</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" data-bs-target="#trash" data-bs-toggle="tab" id="trash-tab" role="tab" type="button">ğŸ—‘ï¸ Ø§Ù„Ù…Ø­Ø°ÙˆÙ / Trash</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" data-bs-target="#compose" data-bs-toggle="tab" id="compose-tab" role="tab" type="button">âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ / Compose</button>
</li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#log" data-bs-toggle="tab" id="log-tab" role="tab" type="button">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ / Message Log</button></li></ul>
<div class="tab-content" id="messageTabsContent">
<!-- Inbox -->
<div class="tab-pane fade show active" id="inbox" role="tabpanel">
<table class="table table-bordered table-striped" id="inboxTable">
<thead class="table-success">
<tr>
<th>Ù…Ù† / From</th>
<th>Ø§Ù„ÙØ±Ø¹ / Branch</th>
<th>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ / Subject</th>
<th>Ø§Ù„Ù†ÙˆØ¹ / Type</th>
<th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</th>
<th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø© / Status</th>
<th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª / Actions</th>
</tr>
</thead>
<tbody>
                    {% for msg in inbox_messages %}
                    <tr class="{% if msg.SenderRole != 'Employee' %}non-employee{% endif %} {% if msg.Status == 'Unread' %}unread{% endif %}">
<td>{{ msg.SenderName }} ({{ msg.SenderRole }})</td>
<td>{{ msg.SenderBranch }}</td>
<td>{{ msg.Subject }}</td>
<td>{{ msg.Type }}</td>
<td>{{ msg.DateSent }}</td>
<td>{{ msg.DateApproved or '-' }}</td>
<td>{{ msg.Status }}</td>
<td>
<a class="btn btn-sm btn-primary" href="/view_message/{{ msg.ID }}">ğŸ“– Ø¹Ø±Ø¶</a>
                            {% if msg.RequiresApproval == 'Yes' and (msg.DateApproved == '' or msg.DateApproved == None or msg.DateApproved == '-') %}
                               <a class="btn btn-sm btn-success" href="/approve_message/{{ msg.ID }}">âœ”ï¸ Ù…ÙˆØ§ÙÙ‚Ø©</a>
<a class="btn btn-sm btn-danger" href="/reject_message/{{ msg.ID }}">âŒ Ø±ÙØ¶</a>
                            {% endif %}
                            <a class="btn btn-sm btn-secondary" href="/reply/{{ msg.ID }}">â†©ï¸ Ø±Ø¯</a>
<a class="btn btn-warning" href="/forward/{{ msg.ID }}">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡</a>
<a class="btn btn-sm btn-outline-danger" href="/delete_message/{{ msg.ID }}">ğŸ—‘ï¸ Ø­Ø°Ù</a>
</td>
</tr>
                    {% endfor %}
                </tbody>
</table>
</div>
<!-- Sent -->
<div class="tab-pane fade" id="sent" role="tabpanel">
<table class="table table-bordered table-striped" id="sentTable">
<thead class="table-primary">
<tr>
<th>Ø¥Ù„Ù‰ / To</th>
<th>Ø§Ù„ÙØ±Ø¹ / Branch</th>
<th>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ / Subject</th>
<th>Ø§Ù„Ù†ÙˆØ¹ / Type</th>
<th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</th>
<th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
<th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody>
                    {% for msg in sent_messages %}
                    <tr>
<td>{{ msg.ReceiverName }} ({{ msg.ReceiverRole }})</td>
<td>{{ msg.ReceiverBranch }}</td>
<td>{{ msg.Subject }}</td>
<td>{{ msg.Type }}</td>
<td>{{ msg.DateSent }}</td>
<td>{{ msg.DateApproved or '-' }}</td>
<td>{{ msg.Status }}</td>
<td>
<a class="btn btn-sm btn-primary" href="/view_message/{{ msg.ID }}">ğŸ“– Ø¹Ø±Ø¶</a>
</td>
</tr>
                    {% endfor %}
                </tbody>
</table>
</div>
<!-- Trash -->
<div class="tab-pane fade" id="trash" role="tabpanel">
<table class="table table-bordered table-striped" id="trashTable">
<thead class="table-danger">
<tr>
<th>Ù…Ù†</th>
<th>Ø¥Ù„Ù‰</th>
<th>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</th>
<th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
<th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody>
                    {% for msg in trash_messages %}
                    <tr>
<td>{{ msg.SenderName }}</td>
<td>{{ msg.ReceiverName }}</td>
<td>{{ msg.Subject }}</td>
<td>{{ msg.DateSent }}</td>
<td>{{ msg.Status }}</td>
<td>
<a class="btn btn-sm btn-primary" href="/view_message/{{ msg.ID }}">ğŸ“– Ø¹Ø±Ø¶</a>
<a class="btn btn-sm btn-danger" href="/delete_permanently/{{ msg.ID }}">ğŸ—‘ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</a>
</td>
</tr>
                    {% endfor %}
                </tbody>
</table>
</div>
<!-- Compose -->
<div class="tab-pane fade" id="compose" role="tabpanel">
<form action="/send_message" method="POST">
                {% if compose_mode == 'reply' %}
                    <input name="replied_to" type="hidden" value="{{ replied_to }}"/>
                {% elif compose_mode == 'forward' %}
                    <input name="forward_from" type="hidden" value="{{ forwarded_from }}"/>
                {% endif %}

                <div class="row mb-3">
<div class="col-md-4">
<label>Ø§Ù„ÙØ±Ø¹:</label>
<select class="form-select" id="branchSelect">
<option value="">Ø§Ø®ØªØ± ÙØ±Ø¹Ù‹Ø§</option>
                            {% for branch in branches %}
                                <option value="{{ branch }}">{{ branch }}</option>
                            {% endfor %}
                        </select>
</div>
<div class="col-md-4">
<label>Ø§Ù„Ø¯ÙˆØ±:</label>
<select class="form-select" disabled="" id="roleSelect">
<option value="">Ø§Ø®ØªØ± Ø¯ÙˆØ±Ù‹Ø§</option>
</select>
</div>
<div class="col-md-4">
<label>Ø§Ù„Ø§Ø³Ù…:</label>
<select class="form-select" disabled="" id="nameSelect" multiple="" name="receiver_ids">
<option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…Ù‹Ø§</option>
</select>
</div>
</div>
<input id="receiverNameHidden" name="receiver_name" type="hidden"/>
<input id="receiverBranchHidden" name="receiver_branch" type="hidden"/>
<input id="receiverRoleHidden" name="receiver_role" type="hidden"/>
<div class="mb-3">
<label>Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</label>
<select class="form-select" name="type" required="">
<option value="Normal">Ø¹Ø§Ø¯ÙŠØ©</option>
<option value="ContractRenewal">Ø·Ù„Ø¨ ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯</option>
<option value="TransferRequest">Ø·Ù„Ø¨ Ù†Ù‚Ù„ Ù…ÙˆØ¸Ù</option>
<option value="ViolationExplanation">Ø·Ù„Ø¨ ØªÙØ³ÙŠØ± Ù…Ø®Ø§Ù„ÙØ©</option>
<option value="Other">Ø£Ø®Ø±Ù‰</option>
</select>
</div>
<div class="mb-3">
<label>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</label>
<input class="form-control" name="subject" required="" type="text" value="{{ subject or '' }}"/>
</div>
<div class="mb-3">
<label>Ø§Ù„Ù…Ø­ØªÙˆÙ‰:</label>
<textarea class="form-control" name="content" required="" rows="4">{{ content or '' }}</textarea>
</div>
<button class="btn btn-success" type="submit">âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„</button>
</form>
</div>
<div class="tab-pane fade" id="log" role="tabpanel">
<table class="table table-bordered table-striped" id="logTable">
<thead class="table-dark">
<tr>
<th>Ø§Ù„Ù…Ø±Ø³Ù„ / Sender</th>
<th>Ø§Ù„Ù…Ø³ØªÙ„Ù… / Receiver</th>
<th>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ / Subject</th>
<th>Ø§Ù„Ù†ÙˆØ¹ / Type</th>
<th>Ø§Ù„ØªØ§Ø±ÙŠØ® / Date</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø© / Status</th>
<th>Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù / Delete Status</th>
</tr>
</thead>
<tbody>
        {% for msg in all_messages %}
        <tr>
<td>{{ msg.SenderName }} ({{ msg.SenderRole }})</td>
<td>{{ msg.ReceiverName }} ({{ msg.ReceiverRole }})</td>
<td>{{ msg.Subject }}</td>
<td>{{ msg.Type }}</td>
<td>{{ msg.DateSent }}</td>
<td>{{ msg.Status }}</td>
<td>{{ msg.DeleteStatus }}</td>
</tr>
        {% endfor %}
    </tbody>
</table>
</div></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script>
    $(document).ready(function () {
        $('#inboxTable, #sentTable, #trashTable, #logTable').DataTable({ "pageLength": 5 });

        const allEmployees = {{ employees_json|safe }};

        $('#branchSelect').on('change', function () {
            const branch = $(this).val();
            const roles = [...new Set(allEmployees.filter(emp => emp['Ø§Ù„ÙØ±Ø¹'] === branch).map(emp => emp['Ø§Ù„Ø¯ÙˆØ±']))];

            $('#roleSelect').html('<option value="">Ø§Ø®ØªØ± Ø¯ÙˆØ±Ù‹Ø§</option>');
            $('#nameSelect').html('<option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…Ù‹Ø§</option>').prop('disabled', true);
            $('#receiverNameHidden, #receiverBranchHidden, #receiverRoleHidden').val("");

            roles.forEach(role => {
                $('#roleSelect').append(`<option value="${role}">${role}</option>`);
            });
            $('#roleSelect').prop('disabled', false);
        });

        $('#roleSelect').on('change', function () {
            const branch = $('#branchSelect').val();
            const role = $(this).val();
            const filtered = allEmployees.filter(emp => emp['Ø§Ù„ÙØ±Ø¹'] === branch && emp['Ø§Ù„Ø¯ÙˆØ±'] === role);

            $('#nameSelect').html('<option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…Ù‹Ø§</option>');
            filtered.forEach(emp => {
                $('#nameSelect').append(`<option value="${emp['Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©']}">${emp['Ø§Ù„Ø§Ø³Ù…']}</option>`);
            });
            $('#nameSelect').prop('disabled', false);
        });

        $('#nameSelect').on('change', function () {
            const id = $(this).val();
            const emp = allEmployees.find(e => e['Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©'] == id);
            if (emp) {
                $('#receiverNameHidden').val(emp['Ø§Ù„Ø§Ø³Ù…']);
                $('#receiverBranchHidden').val(emp['Ø§Ù„ÙØ±Ø¹']);
                $('#receiverRoleHidden').val(emp['Ø§Ù„Ø¯ÙˆØ±']);
            }
        });

        // âœ… ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ "Ø¥Ø±Ø³Ø§Ù„" ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
        const composeMode = "{{ compose_mode | default('') }}";
        if (composeMode === "reply" || composeMode === "forward") {
            const composeTab = new bootstrap.Tab(document.querySelector('#compose-tab'));
            composeTab.show();
        }

        // âœ… ÙÙ‚Ø· ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ØŒ Ø§Ù…Ù„Ø£ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
        if (composeMode === "reply") {
            const receiverId = "{{ receiver_id or '' }}";
            const receiverName = "{{ receiver_name or '' }}";
            const receiverBranch = "{{ receiver_branch or '' }}";
            const receiverRole = "{{ receiver_role or '' }}";

            $('#receiverNameHidden').val(receiverName);
            $('#receiverBranchHidden').val(receiverBranch);
            $('#receiverRoleHidden').val(receiverRole);

            $('#nameSelect').append(`<option value="${receiverId}" selected>${receiverName}</option>`);
            $('#nameSelect').prop('disabled', false);

            $('#roleSelect').append(`<option value="${receiverRole}" selected>${receiverRole}</option>`);
            $('#roleSelect').prop('disabled', false);

            $('#branchSelect').append(`<option value="${receiverBranch}" selected>${receiverBranch}</option>`);
            $('#branchSelect').prop('disabled', false);
        }
    });
</script>
</body>
</html>
