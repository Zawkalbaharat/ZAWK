<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>مهام موظف الموارد / HR Tasks</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background:#f5f5f5; padding:20px; }
        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .header h2 { color:#2c3e50; }
        .back-button { padding:8px 16px; border:none; border-radius:6px; background:#3498db; color:white; cursor:pointer; }
        .back-button:hover { background:#2980b9; }
        form.add-task { background:#fff; padding:15px; margin-bottom:20px; border-radius:8px; box-shadow:0 0 5px rgba(0,0,0,0.1); display:flex; gap:10px; flex-wrap:wrap; }
        form.add-task input, form.add-task textarea, form.add-task button { padding:8px; border:1px solid #ccc; border-radius:4px; }
        form.add-task textarea { width:200px; height:40px; }
        form.add-task button { background:#27ae60; color:white; cursor:pointer; }
        form.add-task button:hover { background:#1e8449; }
        table.dataTable th, table.dataTable td { white-space:nowrap; }
        input[type='number'] { width:70px; }
    </style>
</head>
<body>
    <div class="header">
        <h2>📋 مهام موظف الموارد / HR Tasks</h2>
        <button onclick="window.location.href='/dashboard'" class="back-button">🔙 رجوع إلى لوحة التحكم / Back to Dashboard</button>
    </div>

    <!-- نموذج إضافة مهمة مباشرة -->
    {% if session['role'] in ['موارد بشرية','مشرف عام'] %}
    <form class="add-task" method="POST" action="/add_or_update_task">
        <input type="hidden" name="action" value="add">
        <input type="text" name="task_name" placeholder="اسم المهمة / Task Name" required>
        <textarea name="task_details" placeholder="تفاصيل المهمة / Task Details"></textarea>
        <input type="date" name="due_date" required>
        <button type="submit">➕ إضافة مهمة / Add Task</button>
    </form>
    {% endif %}

    <!-- جدول المهام -->
    <table id="tasksTable" class="display nowrap" style="width:100%">
        <thead>
            <tr>
                <th>رقم المهمة<br>Task ID</th>
                <th>تاريخ الإضافة<br>Added Date</th>
                <th>المهمة<br>Task Name</th>
                <th>تفاصيل<br>Task Details</th>
                <th>بإسناد من<br>Assigned By</th>
                <th>حالة المهمة<br>Status</th>
                <th>تاريخ الانتهاء المطلوب<br>Due Date</th>
                <th>إجراء الموارد<br>HR Action</th>
                <th>تقييم المشرف<br>Supervisor Evaluation</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr>
                <td>{{ task.task_id }}</td>
                <td>{{ task.added_date }}</td>
                <td>{{ task.task_name }}</td>
                <td>{{ task.task_details }}</td>
                <td>{{ task.assigned_by }}</td>
                <td>{{ task.status }}</td>
                <td>{{ task.due_date }}</td>
                <td>
                   {% if session['role'] == 'موارد بشرية' %}
                   <form action="/add_or_update_task" method="POST" style="display:inline;">
                       <input type="hidden" name="action" value="complete">
                       <input type="hidden" name="task_id" value="{{ task.task_id }}">
                       <button type="submit" style="padding:4px 8px;background:#3b2ecc;color:white;border:none;border-radius:4px;cursor:pointer;">
                           ✅ هل تمت المهمة؟
                       </button>
                   </form>
                   {% else %}
                       {{ task.status }}
                   {% endif %}
                </td>

                <td>
                    {% if session['role'] == 'مشرف عام' %}
                    <form action="/add_or_update_task" method="POST" style="display:flex;gap:5px;">
                        <input type="hidden" name="action" value="evaluate">
                        <input type="hidden" name="task_id" value="{{ task.task_id }}">
                        <input type="number" name="evaluation" min="1" max="10" value="{{ task.supervisor_evaluation or '' }}" required>
                        <button type="submit">حفظ</button>
                    </form>
                    <form action="/add_or_update_task" method="POST" onsubmit="return confirm('هل أنت متأكد من الحذف؟');">
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="task_id" value="{{ task.task_id }}">
                        <button type="submit" style="background:#e74c3c;color:white;border:none;padding:3px 8px;border-radius:4px;cursor:pointer;">حذف</button>
                    </form>
                    {% else %}
                        {{ task.supervisor_evaluation }}
                    {% endif %}
                </td>

            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        $(document).ready(function() {
            var table = $('#tasksTable').DataTable({
                responsive: true,
                dom: 'Bfrtip',
                buttons: [
                    { extend: 'excelHtml5', text: '💾 تصدير Excel' },
                    { extend: 'pdfHtml5', text: '🖨️ تصدير PDF' },
                    { extend: 'print', text: '🖨️ طباعة' }
                ],
                language: {
                    search: "🔍 بحث:",
                    lengthMenu: "عرض _MENU_ مهام",
                    info: "عرض _START_ إلى _END_ من أصل _TOTAL_ مهمة",
                    paginate: { first: "الأولى", last: "الأخيرة", next: "التالي", previous: "السابق" },
                    zeroRecords: "لا توجد مهام مطابقة",
                    infoEmpty: "لا توجد بيانات",
                    infoFiltered: "(تمت التصفية من إجمالي _MAX_ مهمة)"
                }
            });

            // ✅ تلوين عمود الحالة باللون الأخضر إذا كانت القيمة "تمت"
            $('#tasksTable').on('draw.dt', function () {
                $('#tasksTable tbody tr').each(function () {
                    var statusCell = $(this).find('td:eq(5)'); // العمود السادس: status
                    if (statusCell.text().trim() === "تمت") {
                        statusCell.css({
                            'background-color': '#d4edda',
                            'color': '#155724',
                            'font-weight': 'bold'
                        });
                    }
                });
            }).trigger('draw.dt');
        });
    </script>
</body>
</html>

