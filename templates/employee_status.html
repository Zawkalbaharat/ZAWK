<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“‹ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† / Employee Status</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <style>
        body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 30px; background-color: #f9f9f9; }
        h2 { color: #2e7d32; text-align: center; margin-bottom: 20px; }
        .btn { padding: 5px 10px; border: none; cursor: pointer; font-weight: bold; }
        .btn-info { background-color: #2196f3; color: white; }
        .btn-success { background-color: #4caf50; color: white; }
        .stat-box { display: inline-block; padding: 10px 20px; background: #f5f5f5; border: 1px solid #ccc; margin: 5px; border-radius: 10px; }
        .editable { background-color: #fffbe6; }
        .red-cell { background-color: #ffe6e6 !important; }
        table.dataTable thead th { background-color: #2e7d32; color: white; }
        .dt-buttons button { margin-left: 5px; }
    
.custom-select {
    padding: 6px 12px;
    font-size: 15px;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid #ced4da;
    border-radius: 0.45rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
    width: 100%;
    min-width: 100px;
}
.custom-select:focus {
    border-color: #80bdff;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

</style>
</head>
<body>

<h2>ğŸ“‹ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† / Employee Status</h2>
<div style="text-align: left; margin-bottom: 20px;">
  <a href="{{ 'hr_dashboard' if role == 'Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ©' else 'admin_dashboard' if role == 'Ù…Ø´Ø±Ù Ø¹Ø§Ù…' else '#' }}" class="btn btn-info">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
</div>

<div id="statistics"></div>
<table id="statusTable" class="display" style="width:100%">
    <thead></thead>
    <tbody></tbody>
</table>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

<script>
function calculateSmartColumns(row) {
    const today = new Date();
    function daysUntil(dateStr) {
        if (!dateStr || typeof dateStr !== "string") return Infinity;
        const date = new Date(dateStr);
        return isNaN(date) ? Infinity : Math.ceil((date - today) / (1000 * 60 * 60 * 24));
    }

    if (row["Ù‡Ù„ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…Ù„ØŸ"] === "Ù†Ø¹Ù…") {
        Object.keys(row).forEach(k => {
            if (k.startsWith("Ù‡Ù„ ÙŠØ­ØªØ§Ø¬")) row[k] = "Ù„Ø§";
        });
        row["Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ§ØªØŸ"] = row["Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ§ØªØŸ"] || "Ù„Ø§";
        row["Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ"] = row["Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ"] || "Ù„Ø§";
    } else {
        row["Ù‡Ù„ ÙŠØ­ØªØ§Ø¬ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©ØŸ"] =
            ["2", "3"].includes(String(row["Ø±Ù…Ø² Ø§Ù„ÙƒÙØ§Ù„Ø©"]).trim()) &&
            daysUntil(row["ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©"]) < 50 ? "Ù†Ø¹Ù…" : "Ù„Ø§";
        row["Ù‡Ù„ ÙŠØ­ØªØ§Ø¬ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ"] =
            String(row["Ù‡Ù„ ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ"]).trim() === "Ù†Ø¹Ù…" &&
            daysUntil(row["ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØµØ­ÙŠØ©"]) < 30 ? "Ù†Ø¹Ù…" : "Ù„Ø§";
        row["Ù‡Ù„ ÙŠØ­ØªØ§Ø¬ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ"] =
            String(row["Ù‡Ù„ ÙŠØ³ØªØ­Ù‚ Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ"]).trim() === "Ù†Ø¹Ù…" &&
            daysUntil(row["ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†"]) < 30 ? "Ù†Ø¹Ù…" : "Ù„Ø§";
        row["Ù‡Ù„ ÙŠØ­ØªØ§Ø¬ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ØŸ"] =
            daysUntil(row["ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯"]) < 90 ? "Ù†Ø¹Ù…" : "Ù„Ø§";
        row["Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ§ØªØŸ"] = "";
        row["Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ"] = "";
    }
    return row;
}

let tableData = [];
let table;

const dateFields = [
    "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©", "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØµØ­ÙŠØ©",
    "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†", "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯"
];

const dropdownFields = {
    "Ù‡Ù„ ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ": ["", "Ù†Ø¹Ù…", "Ù„Ø§"],
    "Ù‡Ù„ ÙŠØ³ØªØ­Ù‚ Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ": ["", "Ù†Ø¹Ù…", "Ù„Ø§"],
    "Ù‡Ù„ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…Ù„ØŸ": ["", "Ù†Ø¹Ù…", "Ù„Ø§"],
    "Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ§ØªØŸ": ["", "Ù†Ø¹Ù…", "Ù„Ø§"],
    "Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ": ["", "Ù†Ø¹Ù…", "Ù„Ø§"]
};

const alwaysEditable = [
    "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©", "Ù‡Ù„ ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ", "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØµØ­ÙŠØ©",
    "Ù‡Ù„ ÙŠØ³ØªØ­Ù‚ Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ", "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†", "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯",
    "Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©", "Ù‡Ù„ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…Ù„ØŸ"
];

function isEditable(column, rowData) {
    if (["Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ§ØªØŸ", "Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ"].includes(column)) {
        return rowData["Ù‡Ù„ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…Ù„ØŸ"] === "Ù†Ø¹Ù…";
    }
    return alwaysEditable.includes(column);
}

function createStatistics(data) {
    const statsContainer = document.getElementById("statistics");
    statsContainer.innerHTML = "";

    const fields = [
        "Ù‡Ù„ ÙŠØ­ØªØ§Ø¬ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©ØŸ", "Ù‡Ù„ ÙŠØ­ØªØ§Ø¬ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ",
        "Ù‡Ù„ ÙŠØ­ØªØ§Ø¬ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ", "Ù‡Ù„ ÙŠØ­ØªØ§Ø¬ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ØŸ",
        "Ù‡Ù„ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…Ù„ØŸ", "Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ§ØªØŸ", "Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ"
    ];

    fields.forEach(field => {
        let count = 0;
        if (field === "Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ§ØªØŸ" || field === "Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ") {
            count = data.filter(row => row[field] === "Ù„Ø§").length;
        } else {
            count = data.filter(row => row[field] === "Ù†Ø¹Ù…").length;
        }
        const box = `<div class='stat-box'><strong>${field}</strong>: ${count}</div>`;
        statsContainer.innerHTML += box;
    });
}

function buildTable(data) {
    data = data.map(calculateSmartColumns);

    // ÙƒØ§Ø¦Ù† ÙŠØ­ÙˆÙŠ Ø£Ø­Ø¯Ø« ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø¬Ø§Ø²Ø© Ù„ÙƒÙ„ Ø±Ù‚Ù… Ù‡ÙˆÙŠØ©
    const latestLeaveDates = {
        "2020202020": "2025-07-15",
        "66665556677": "2025-07-15"
        // â† Ø£Ø¶Ù Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ø¨Ø± Ø¨Ø§ÙŠØ«ÙˆÙ† Ø£Ùˆ JSON Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    };

    const allowedColumns = [
        "Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„ÙØ±Ø¹", "Ø§Ù„Ø¯ÙˆØ±", "Ø±Ù…Ø² Ø§Ù„ÙƒÙØ§Ù„Ø©", "Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ",
        "ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©", // â† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§
        "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©", "Ù‡Ù„ ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ", "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØµØ­ÙŠØ©",
        "Ù‡Ù„ ÙŠØ³ØªØ­Ù‚ Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ", "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†",
        "ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯", "Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©", "Ù‡Ù„ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…Ù„ØŸ",
        "Ù‡Ù„ ÙŠØ­ØªØ§Ø¬ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©ØŸ", "Ù‡Ù„ ÙŠØ­ØªØ§Ø¬ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ",
        "Ù‡Ù„ ÙŠØ­ØªØ§Ø¬ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ", "Ù‡Ù„ ÙŠØ­ØªØ§Ø¬ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ØŸ",
        "Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ§ØªØŸ", "Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ"
    ];

    const filteredData = data.map(row => {
        const filteredRow = {};
        allowedColumns.forEach(col => filteredRow[col] = row[col] ?? "");

        // Ø¥Ø¶Ø§ÙØ© ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ù…Ù† Ø§Ù„ÙƒØ§Ø¦Ù† Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
        const id = String(row["Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©"]).trim();
        filteredRow["ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©"] = latestLeaveDates[id] || "";

        if (!filteredRow["Ù‡Ù„ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…Ù„ØŸ"]) filteredRow["Ù‡Ù„ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…Ù„ØŸ"] = "Ù„Ø§";
        return filteredRow;
    });

    const columns = allowedColumns.map(col => ({ title: col, data: col }));

    table = $('#statusTable').DataTable({
        data: filteredData,
        columns: columns,
        dom: 'Bfrtip',
        buttons: ['excelHtml5', 'print'],
        paging: true,
        responsive: true,
        destroy: true,
        createdRow: function (row, rowData) {
            for (let key in rowData) {
                if (rowData[key] === "Ù†Ø¹Ù…" && key.includes("ÙŠØ­ØªØ§Ø¬")) {
                    $('td', row).eq(Object.keys(rowData).indexOf(key)).addClass('red-cell');
                }
                if (rowData["Ù‡Ù„ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…Ù„ØŸ"] === "Ù†Ø¹Ù…" &&
                    rowData[key] === "Ù„Ø§" &&
                    (key === "Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ§ØªØŸ" || key === "Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ")) {
                    $('td', row).eq(Object.keys(rowData).indexOf(key)).addClass('red-cell');
                }
            }
        }
    });

    createStatistics(filteredData);
}

$(document).ready(function() {
    const rawData = {{ data | tojson | safe }};
    const role = "{{ role }}";
    tableData = rawData.map(row => {
        if (!row["Ù‡Ù„ ÙŠØ³ØªØ­Ù‚ Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ"]) row["Ù‡Ù„ ÙŠØ³ØªØ­Ù‚ Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ"] = "Ù†Ø¹Ù…";
        if (!row["Ù‡Ù„ ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ"]) row["Ù‡Ù„ ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ"] = "Ù†Ø¹Ù…";
        return row;
    });
    if (tableData.length > 0) buildTable(tableData);

    if (["Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ©", "Ù…Ø´Ø±Ù Ø¹Ø§Ù…"].includes(role)) {
        $('#statusTable tbody').on('click', 'td', function () {
            const colIndex = $(this).index();
            const rowIndex = table.row($(this).closest('tr')).index();
            const column = table.settings().init().columns[colIndex].title;
            const rowData = table.row($(this).closest('tr')).data();
            if (!isEditable(column, rowData)) return;
            const currentValue = table.cell(this).data();

            function updateAndRecalc(value) {
                table.cell(rowIndex, colIndex).data(value).draw(false);
                let rowData = table.row(rowIndex).data();
                if (column === "Ù‡Ù„ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…Ù„ØŸ") {
                    if (value === "Ù†Ø¹Ù…") {
                        Object.keys(rowData).forEach(k => {
                            if (k.startsWith("Ù‡Ù„ ÙŠØ­ØªØ§Ø¬")) rowData[k] = "Ù„Ø§";
                        });
                        rowData["Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ§ØªØŸ"] = "Ù„Ø§";
                        rowData["Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ"] = "Ù„Ø§";
                    } else {
                        rowData = calculateSmartColumns(rowData);
                        rowData["Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ§ØªØŸ"] = "";
                        rowData["Ù‡Ù„ Ø±ÙÙØ¹ Ù…Ù† Ø§Ù„ØªØ£Ù…ÙŠÙ†ØŸ"] = "";
                    }
                } else {
                    rowData = calculateSmartColumns(rowData);
                }
                table.row(rowIndex).data(rowData).draw(false);
            }

            if (dropdownFields[column]) {
                const select = $('<select class="custom-select"></select>');
                dropdownFields[column].forEach(opt => {
                    select.append(`<option value="${opt}" ${opt === currentValue ? 'selected' : ''}>${opt}</option>`);
                });
                $(this).html(select);
                select.focus().on('change blur', function () {
                    updateAndRecalc($(this).val());
                });
            } else if (dateFields.includes(column)) {
                const input = $('<input type="text" class="datepicker" autocomplete="off"/>');
                input.val(currentValue && currentValue !== 'NaN' ? currentValue : '');
                $(this).empty().append(input);
                input.datepicker({
                    dateFormat: 'yy-mm-dd',
                    changeMonth: true,
                    changeYear: true,
                    showButtonPanel: true,
                    onClose: function () {
                        updateAndRecalc($(this).val());
                    }
                });
                input.focus();
            } else {
                const input = $('<input type="text" />');
                input.val(currentValue);
                $(this).html(input);
                input.focus().on('blur', function () {
                    updateAndRecalc($(this).val());
                });
            }
        });

        const saveButton = $('<button class="btn btn-success">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>');
        saveButton.on('click', function () {
            const updatedData = table.rows().data().toArray();
            $.ajax({
                url: "/update_employee_status",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(updatedData),
                success: function () {
                    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
                },
                error: function () {
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
                }
            });
        });
        $("#statistics").append(saveButton);
    }
});
</script>
<!-- ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ Ù„ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„ÙˆØ³Ø· -->
<style>
    #branchStats td, #branchStats th {
        text-align: center;
    }
    #branchStats tfoot td {
        font-weight: bold;
        background: #f1f1f1;
    }
</style>

<h3 style="margin-top:40px; text-align:center; color:#2e7d32;">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±ÙˆØ¹ / Branch Statistics</h3>
<table id="branchStats" class="display" style="width:100%">
    <thead>
        <tr>
            <th>Ø§Ù„ÙØ±Ø¹</th>
            <th>ØªØ±Ùƒ Ø§Ù„Ø¹Ù…Ù„</th>
            <th>Ù„Ù… ÙŠØªØ±Ùƒ Ø§Ù„Ø¹Ù…Ù„</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
        <tr>
            <td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
            <td id="totalLeft">0</td>
            <td id="totalStayed">0</td>
            <td id="totalAll">0</td>
        </tr>
    </tfoot>
</table>

<script>
function buildBranchStats(data){
    const branchMap = {};
    let totalLeft = 0, totalStayed = 0, totalAll = 0;

    data.forEach(row=>{
        const branch = row["Ø§Ù„ÙØ±Ø¹"] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        if(!branchMap[branch]) branchMap[branch] = { left:0, stayed:0, total:0 };
        if(row["Ù‡Ù„ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…Ù„ØŸ"] === "Ù†Ø¹Ù…") branchMap[branch].left++;
        else branchMap[branch].stayed++;
        branchMap[branch].total++;
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù…
        totalLeft += (row["Ù‡Ù„ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…Ù„ØŸ"] === "Ù†Ø¹Ù…") ? 1 : 0;
        totalStayed += (row["Ù‡Ù„ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…Ù„ØŸ"] !== "Ù†Ø¹Ù…") ? 1 : 0;
        totalAll++;
    });

    const stats = Object.keys(branchMap).map(branch=>({
        branch: branch,
        left: branchMap[branch].left,
        stayed: branchMap[branch].stayed,
        total: branchMap[branch].total
    }));

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    document.getElementById("totalLeft").textContent = totalLeft;
    document.getElementById("totalStayed").textContent = totalStayed;
    document.getElementById("totalAll").textContent = totalAll;

    $('#branchStats').DataTable({
        data: stats,
        columns: [
            { data: 'branch' },
            { data: 'left' },
            { data: 'stayed' },
            { data: 'total' }
        ],
        dom: 'Bfrtip',
        buttons: ['excelHtml5','print'],
        paging: false,
        searching: false,
        info: false,
        destroy: true
    });
}

// Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
$(document).ready(function(){
    if(tableData.length>0){
        buildBranchStats(tableData);
    }
});
</script>

</body>
</html>
